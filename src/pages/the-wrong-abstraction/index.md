---
title: Неправильная абстракция
date: '2016-01-20'
author: Sandi Metz
origin: https://sandimetz.com/blog/2016/1/20/the-wrong-abstraction
---

Я думала о последствиях "плохой асбтракции". Моё выступление
"все маленькие вещи[https://www.youtube.com/watch?v=8bZh5LMaSmE&featu..]" на конференции RailsConf 2014 включал секцию, где я
утверждала [https://www.youtube.com/watch?v=8bZh5LMaSmE&featu..]:

*дубликация намного дешевле, чем неправильная асбтракция*

И в заключении я дала такой совет[https://www.youtube.com/watch?v=8bZh5LMaSmE&featu..]:

*продпочитайте дублированиии плохой абстракции*

На удивление, этот маленький кусок большого выступления вызывал сильную реакцию.
Несколько ребят предположили, что я сошла с ума, но намного больше людей выражали свою чувства так:

*пикчи с инстача*

Сила реакции заставила менять понять насколько проблема "неправильной абстракции"
широко распростронена и трудна. Я начала задавать вопросы и увидела такой паттерн:

1. Программист A видит дублирование кода.

2. Программист A извлекает дублирование и даёт ему название
*Это создаёт новую абстракцию. Это можеть быть метод или, возможно, даже новый класс.*

3. Программист A заменяет дублирование новой абстракцией.
*Ах, код совершенен. Программист A счастливо умывает руки.*

4. Прохоидт время.

5. Появляются новые требование, для которых новая абстракция *почти* безупречна.

6. Программист B получает задачу по имплементации новых тербований.
*Программист B считает за честь сохранить текущую абстракцию, но т.к.
абстракция больше не подходит для всех случаев, он меняет код,
добавляет параметр и условия что бы делать правльные вещи,
основываясь на значении этого параметра.

То что было универсальной абстракцией, теперь ведёт себя по-разному в разных случаях.*

7. Поступают новые требования.
*Программист X.
Новый допольнительный параметр.
Ещё одно новое условие.
Зациклить до тех пор, до тех пор пока код не станет непонятным.*

8. Здесь вы появляетесь в истории и ваша жизнь резко
меняется в худшую сторону.


Существующий код оказывает мощное влияние. Само существование кода
утверждает что это правильно и необходимо. Мы знаем, что код так же
представляет собой затраченные усилия и мы очень мотивированы в том,
что бы сохрнаить значимость этих усилий. К сожалению, грустная правда в том,
что чем запутаннее и труднее код, т.е. чем больше в него было вложено усилий,
тем больше мы чувствуем себя обязанными сохранить этот код ("невозвратныее затраты" [https://en.wikipedia.org/wiki/Sunk_cost#Loss_aversion..]).
Наше подсознание говорит нам, "Госоподи, здесь всё так запутано, наверно
потребовались годы, что бы написать этот код правильно. Конечно, всё это очень,
очень важно. Было бы грешно, позволить всем этим усилиям пропость."

Когда вы появились в этой истории, на пункте 8, это давление могло вас заставить
идти вперёд и реализовать новые требования, путём изменения существующего кода.
Пробовать сделать это - довольно жестоко. Код больше не представляет собой единственную,
общую абстракци, вместо этого он будет нагружен условиями, которые чередуют
ряд слабо связанных идей. Такой код тяжело понять и легко сломать.

Если вы находитесь в схожей ситуации, не будьте движимыми невозвратными затратами.
Когда вы имеете дело с неправильной абстракцией, *самый быстрый спобоб продвинуться вперёд,
это повернуть назад*. Сделайте следущее:

1. Введите дублирование, вставляя абстрагированный код обратно, в каждый вызывающий его метод.
2. Внутри такого метода, используйте параметры, которые ранее были переданы в абстракцию,
что бы определить тот код, который вызывал этот конкретный метод в абстракции.
3. Удалите те куски кода, которые не нужны этому конкретному методу.

Это поможет справиться с абстракцией и с условиями, а так же уменьшит метод
до того кода, который ему необходим. Таким образом, когда вы отматаете код
назад, вы обнаружите, что несмотря на то, что каждый метод якобы вызывал
общую абстракцию, код, который они выполняли был уникальным. Как только
вы удалите одну старую абстракцию, можете начать всё заново с другими
абстракциями, вводить дублирование и извлекать абстракции.

Я сталкивалась с проблемами, когда ребята отважно стралались двигаться вперёд с неправильной абстракцией, но не преуспели. Добавление новых фич было невероятно сложным и каждый успех усложнял код, что делало добавление следующих фич ещё более сложным. Но как только они поменяли свою точку зрения с "я должен сохранить наш труд вложенный в этот код" на "этот код имел смысл некоторое время, но возможно мы получили из него всё что могли" и дали себе обещание переосмыслить их абстракции в свете текущих требований, всё стало намного проще. С тех пор как они переписали код, путь вперёд стал очевиднее, а добавление новых фич проще и быстрее.

Какая мораль этой истории? Не попадайтесь в ловушку невозвратных затрат. Если вы понимаете, что вам приходиться передавать параметры и добавлять условия в общем коде - абстракция неправильна. Возможно, было правильно с неё начинать, но тот день прошёл. Как только вы поняли, что абстракция неправильна, лучшая стратегия - вернуть дублирование и понять с помошью него, что следует делать. Хотя, иногда и имеет смысл наличие нескольких условий для получения представления о происходящем, но вы испытаете меньше боли если, откажитесь от неправильной абстракции раньше.

Когда абстракция неправильна, быстрейший путь вперёд - это повернуть назад. Это не отступление, это продвижение вперёд по лучшему пути. Сделайте это. Вы улучшите свою жизнь и жизни тех, кто последует за вами.
